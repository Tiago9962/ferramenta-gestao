<!DOCTYPE html>
<html lang="pt-BR" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestão Definitiva 5.0 - Funcional</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --bg-color: #f5f3f1;
            --text-color: #3f3c3a;
            --card-bg: #ffffff;
            --border-color: #e5e7eb;
            --header-text: #1f2937;
            --subtext-color: #4b5563;
        }
        [data-theme="dark"] {
            --bg-color: #1c1c1c;
            --text-color: #e5e7eb;
            --card-bg: #2a2a2a;
            --border-color: #4b5563;
            --header-text: #f9fafb;
            --subtext-color: #9ca3af;
        }
        body { font-family: 'Inter', sans-serif; background-color: var(--bg-color); color: var(--text-color);
        transition: background-color 0.3s, color 0.3s; }
        .main-container { max-width: 1600px; margin: auto;
        padding: 1rem; }
        .card { background-color: var(--card-bg); border-radius: 0.75rem; padding: 1.5rem;
        box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        transition: transform 0.2s, background-color 0.3s; border: 1px solid var(--border-color); }
        .card:hover { transform: translateY(-4px);
        }
        .nav-button { padding: 0.75rem 1.5rem; border-radius: 0.5rem; font-weight: 500; cursor: pointer;
        transition: background-color 0.3s, color 0.3s; border: 2px solid transparent; }
        .nav-button.active { background-color: #3b82f6;
        color: #ffffff; }
        .nav-button:not(.active) { background-color: #e5e7eb; color: #374151;
        }
        [data-theme="dark"] .nav-button:not(.active) { background-color: #4b5563; color: #e5e7eb;
        }
        .nav-button:not(.active):hover { background-color: #d1d5db;
        }
        [data-theme="dark"] .nav-button:not(.active):hover { background-color: #6b7280;
        }
        .chart-container { position: relative; width: 100%; height: 300px; max-height: 400px;
        }
        table { width: 100%; border-collapse: collapse;
        }
        th, td { text-align: left; padding: 0.75rem; border-bottom: 1px solid var(--border-color);
        }
        th { background-color: var(--bg-color); font-weight: 600;
        }
        tbody tr:hover { background-color: rgba(59, 130, 246, 0.1);
        }
        .status-low { background-color: #fee2e2; color: #b91c1c;
        }
        .status-ok { background-color: #dcfce7; color: #166534;
        }
        .status-badge { padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 500;
        }
        .form-group label { display: block; margin-bottom: 0.5rem; font-weight: 500; color: var(--text-color);
        }
        .form-group input, .form-group select { width: 100%; padding: 0.75rem;
        border: 1px solid var(--border-color); border-radius: 0.5rem; box-sizing: border-box; background-color: var(--card-bg); color: var(--text-color);
        }
        .btn-primary { background-color: #3b82f6; color: #ffffff; padding: 0.75rem 1.5rem; border-radius: 0.5rem;
        font-weight: 600; cursor: pointer; transition: background-color 0.3s; border: none; }
        .btn-primary:hover { background-color: #2563eb;
        }
        .btn-secondary { background-color: #6b7280; color: #ffffff; padding: 0.5rem 1rem; border-radius: 0.375rem;
        font-weight: 500; font-size: 0.875rem; cursor: pointer; transition: background-color 0.3s; }
        .btn-secondary:hover { background-color: #4b5563;
        }
        .btn-delete { background-color: #ef4444; color: #ffffff; padding: 0.5rem 0.75rem; border-radius: 0.375rem;
        font-size: 0.875rem; cursor: pointer; transition: background-color 0.3s; margin-left: 0.5rem; }
        .btn-delete:hover { background-color: #dc2626;
        }
        .hidden { display: none;
        }
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0;
        background-color: rgba(0, 0, 0, 0.6); display: flex; align-items: center; justify-content: center; z-index: 1000;
        }
        .modal-content { background-color: var(--card-bg); padding: 2rem; border-radius: 0.75rem;
        box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        max-width: 90%; width: 600px; max-height: 90vh; overflow-y: auto;}
        .header-actions { display: flex;
        justify-content: space-between; align-items: center; margin-bottom: 2rem; }
        #notifications-bell { position: relative; cursor: pointer;
        font-size: 1.5rem; color: var(--subtext-color); }
        #notification-count { position: absolute; top: -5px; right: -10px;
        background-color: #ef4444; color: white; border-radius: 50%; width: 20px; height: 20px; font-size: 12px; display: flex; align-items: center; justify-content: center; font-weight: bold;
        }
        #notifications-panel { position: absolute; top: 40px; left: 0; width: 300px; background-color: var(--card-bg);
        border: 1px solid var(--border-color); border-radius: 0.5rem; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 1010; max-height: 400px; overflow-y: auto;
        }
        .notification-item { padding: 0.75rem; border-bottom: 1px solid var(--border-color);
        }
        .notification-item:last-child { border-bottom: none;
        }
    </style>
</head>
<body class="antialiased">
    
    <div id="login-container" class="modal-overlay" style="display: flex;">
        <div class="modal-content" style="max-width: 400px; background-color: var(--card-bg);">
            <h2 class="text-2xl font-bold text-center mb-6" style="color: var(--header-text);">Login - Gestão Definitiva</h2>
            <div class="form-group">
                <label for="login-email">Email:</label>
                <input type="email" id="login-email" required>
            </div>
            <div class="form-group">
                <label for="login-password">Senha:</label>
                <input type="password" id="login-password" required>
            </div>
            <button id="login-btn" class="btn-primary w-full mt-4">Entrar</button>
            <p id="login-error" class="text-red-500 text-center mt-2 h-4"></p>
        </div>
    </div>
    
    <div class="main-container" style="display: none;">
        <header class="text-center my-6">
            <div class="header-actions">
                <div class="relative">
                    <div id="notifications-bell"><i class="fas fa-bell"></i><span id="notification-count" class="hidden">0</span></div>
                    <div id="notifications-panel" class="hidden"></div>
                </div>
                <div>
                    <h1 class="text-4xl font-bold text-gray-800" style="color: var(--header-text);">Gestão Definitiva 5.0</h1>
                    <p class="text-lg mt-2" style="color: var(--subtext-color);">Sua empresa no controle, com relatórios e automações avançadas.</p>
                </div>
                <div class="flex items-center gap-4">
                    <button id="theme-toggle" class="text-xl p-2" title="Mudar tema"><i class="fas fa-moon"></i></button>
                    <button id="logout-btn" class="btn-secondary" title="Sair"><i class="fas fa-sign-out-alt mr-2"></i>Sair</button>
                </div>
            </div>
        </header>

        <nav class="flex justify-center items-center flex-wrap gap-2 md:gap-4 mb-8">
            <button id="nav-overview" class="nav-button active">Visão Geral</button>
            <button id="nav-stock" class="nav-button">Estoque</button>
            <button id="nav-cashflow" class="nav-button">Fluxo de Caixa</button>
            <button id="nav-finance" class="nav-button">Financeiro</button>
            <button id="nav-receivables" class="nav-button">Valores a Receber</button>
            <div class="relative inline-block text-left">
                <button id="nav-reports" class="nav-button">Relatórios <i class="fas fa-chevron-down ml-2"></i></button>
                <div id="reports-dropdown" class="origin-top-right absolute right-0 mt-2 w-56 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5 focus:outline-none hidden" style="background-color: var(--card-bg);">
                    <div class="py-1" role="menu" aria-orientation="vertical" aria-labelledby="options-menu">
                        <a href="#" id="report-abc" class="block px-4 py-2 text-sm" style="color: var(--text-color);" role="menuitem">Curva ABC de Produtos</a>
                        <a href="#" id="report-dre" class="block px-4 py-2 text-sm" style="color: var(--text-color);" role="menuitem">DRE Gerencial</a>
                    </div>
                </div>
            </div>
            <button id="nav-entities" class="nav-button">Entidades</button>
        </nav>

        <main>
            <div id="content-overview">
                <div class="card mb-6">
                    <div class="flex flex-col md:flex-row justify-end items-center gap-4">
                        <div class="flex items-center">
                            <label for="dashboard-period" class="mr-2 font-medium">Período:</label>
                            <select id="dashboard-period" class="form-group select w-48">
                                <option value="all">Todo o Período</option>
                                <option value="30">Últimos 30 dias</option>
                                <option value="90">Últimos 90 dias</option>
                                <option value="month">Este Mês</option>
                                <option value="year">Este Ano</option>
                                <option value="custom">Período Personalizado</option>
                            </select>
                        </div>
                        <div id="custom-date-range" class="flex items-center gap-2 hidden">
                            <input type="date" id="start-date" class="form-group input">
                            <span>a</span>
                            <input type="date" id="end-date" class="form-group input">
                            <button id="apply-custom-range" class="btn-secondary px-4 py-2 text-sm">Aplicar</button>
                        </div>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-6 mb-8">
                    <div class="card text-center"><h3 class="font-semibold" style="color: var(--subtext-color);">Valor em Estoque</h3><p id="kpi-stock-value" class="text-3xl font-bold mt-2">R$ 0,00</p></div>
                    <div class="card text-center"><h3 class="font-semibold" style="color: var(--subtext-color);">Itens em Estoque Baixo</h3><p id="kpi-low-stock" class="text-3xl font-bold text-red-600 mt-2">0</p></div>
                    <div class="card text-center"><h3 class="font-semibold" style="color: var(--subtext-color);">Saldo em Caixa</h3><p id="kpi-balance" class="text-3xl font-bold text-blue-600 mt-2">R$ 0,00</p></div>
                    <div class="card text-center"><h3 class="font-semibold" style="color: var(--subtext-color);">Lucro do Período</h3><p id="kpi-profit" class="text-3xl font-bold text-purple-600 mt-2">R$ 0,00</p></div>
                    <div class="card text-center"><h3 class="font-semibold" style="color: var(--subtext-color);">Total de Valores a Receber</h3><p id="kpi-total-receivables" class="text-3xl font-bold text-orange-600 mt-2">R$ 0,00</p></div>
                </div>
                <div class="card"><h3 class="text-xl font-semibold mb-4 text-center">Receitas vs. Despesas</h3><div class="chart-container"><canvas id="revenueExpenseChart"></canvas></div></div>
            </div>

            <div id="content-stock" class="hidden">
                 <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <div class="lg:col-span-2 card">
                        <div class="flex justify-between items-center mb-4">
                             <h3 class="text-xl font-semibold">Lista de Produtos</h3>
                            <div>
                                 <label for="csv-upload" class="btn-secondary cursor-pointer mr-2"><i class="fas fa-upload mr-2"></i>Importar CSV</label>
                                <input type="file" id="csv-upload" class="hidden" accept=".csv">
                                <button id="stock-adjust-btn" class="btn-secondary mr-2"><i class="fas fa-exchange-alt mr-2"></i>Ajustar Estoque</button>
                                <button id="add-product-btn" class="btn-primary"><i class="fas fa-plus mr-2"></i>Adicionar Produto</button>
                            </div>
                        </div>
                        <input type="search" id="product-search" placeholder="Buscar produto..." class="p-2 border rounded w-full mb-4" style="border-color: var(--border-color); background-color: var(--bg-color);">
                        <div class="overflow-x-auto"><table id="products-table"><thead><tr><th>SKU</th><th>Produto</th><th>Qtd.</th><th>Cor</th><th>Custo</th><th>Venda</th><th>Status</th><th>Ações</th></tr></thead><tbody></tbody></table></div>
                    </div>
                    <div class="card hidden" id="product-form-card"><h3 id="product-form-title" class="text-xl font-semibold mb-4"></h3><form id="product-form"></form></div>
                </div>
            </div>
            
            <div id="content-cashflow" class="hidden">
                 <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <div class="lg:col-span-2 card">
                     <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl font-semibold">Últimas Transações</h3>
                            <button id="add-transaction-btn" class="btn-primary"><i class="fas fa-plus mr-2"></i>Adicionar Transação</button>
                        </div>
                        <input type="search" id="transaction-search" placeholder="Buscar transação..." class="p-2 border rounded w-full mb-4" style="border-color: var(--border-color); background-color: var(--bg-color);">
                        <div class="overflow-x-auto"><table id="transactions-table"><thead><tr><th>Data</th><th>Descrição</th><th>Cliente/Fornecedor</th><th>Tipo</th><th>Valor</th><th>Status</th><th>Ações</th></tr></thead><tbody></tbody></table></div>
                    </div>
                    <div class="card hidden" id="transaction-form-card"><h3 id="transaction-form-title" class="text-xl font-semibold mb-4"></h3><form id="transaction-form"></form></div>
                </div>
            </div>

            <div id="content-finance" class="hidden">
                <div class="card mb-6">
                    <div class="flex flex-col md:flex-row justify-end items-center gap-4">
                        <div class="flex items-center">
                            <label for="finance-period" class="mr-2 font-medium">Período:</label>
                            <select id="finance-period" class="form-group select w-48">
                                 <option value="all">Todo o Período</option>
                                <option value="30">Últimos 30 dias</option>
                                <option value="90">Últimos 90 dias</option>
                                 <option value="month">Este Mês</option>
                                <option value="year">Este Ano</option>
                                 <option value="custom">Período Personalizado</option>
                            </select>
                        </div>
                        <div id="custom-finance-date-range" class="flex items-center gap-2 hidden">
                            <input type="date" id="finance-start-date" class="form-group input">
                            <span>a</span>
                            <input type="date" id="finance-end-date" class="form-group input">
                             <button id="apply-finance-custom-range" class="btn-secondary px-4 py-2 text-sm">Aplicar</button>
                        </div>
                    </div>
                 </div>
                <div class="card mb-8"><h3 class="text-xl font-semibold mb-4 text-center">Receitas vs. Despesas Financeiro</h3><div class="chart-container"><canvas id="financeRevenueExpenseChart"></canvas></div></div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <div class="card">
                         <h3 class="text-xl font-semibold mb-4 text-red-600">Contas a Pagar</h3>
                        <div class="overflow-x-auto"><table id="payable-table"><thead><tr><th>Vencimento</th><th>Descrição</th><th>Valor</th></tr></thead><tbody></tbody></table></div>
                    </div>
                    <div class="card">
                         <h3 class="text-xl font-semibold mb-4 text-green-600">Contas a Receber</h3>
                        <div class="overflow-x-auto"><table id="receivable-table"><thead><tr><th>Vencimento</th><th>Descrição</th><th>Valor</th></tr></thead><tbody></tbody></table></div>
                    </div>
                </div>
            </div>

            <div id="content-receivables" class="hidden">
                <div class="card">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-semibold">Valores a Receber de Clientes</h3>
                     </div>
                    <div class="overflow-x-auto"><table id="client-receivables-table"><thead><tr><th>Data da Compra</th><th>Cliente</th><th>Produto/Descrição</th><th>Valor Total</th><th>Valor Pago</th><th>Desconto</th><th>Valor Devido</th><th>Status</th><th>Ações</th></tr></thead><tbody></tbody></table></div>
                </div>
            </div>

            <div id="content-entities" class="hidden">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <div class="card">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl font-semibold">Clientes</h3>
                             <button id="add-client-btn" class="btn-primary"><i class="fas fa-plus mr-2"></i>Adicionar Cliente</button>
                        </div>
                        <div class="overflow-x-auto mt-6"><table id="clients-table"><thead><tr><th>ID</th><th>Nome</th><th>Contato</th><th>Ações</th></tr></thead><tbody></tbody></table></div>
                    </div>
                     <div class="card">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl font-semibold">Fornecedores</h3>
                             <button id="add-supplier-btn" class="btn-primary"><i class="fas fa-plus mr-2"></i>Adicionar Fornecedor</button>
                        </div>
                        <div class="overflow-x-auto mt-6"><table id="suppliers-table"><thead><tr><th>ID</th><th>Nome</th><th>Contato</th><th>Ações</th></tr></thead><tbody></tbody></table></div>
                     </div>
                </div>
                <div class="card hidden mt-8" id="entity-form-card"><h3 id="entity-form-title" class="text-xl font-semibold mb-4"></h3><form id="entity-form"></form></div>
            </div>
            
        </main>
        <footer class="text-center mt-12 mb-4">
             <button id="download-excel-btn" class="btn-primary ml-4">Baixar Resumo (Excel)</button>
        </footer>
    </div>

    <div id="modal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h2 id="modal-title" class="text-2xl font-bold"></h2>
                <button id="modal-close-btn" class="text-2xl">&times;</button>
             </div>
            <div id="modal-body"></div>
        </div>
    </div>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    
    <script>
    // ================================================================= -->
    // =========== INICIALIZAÇÃO E LÓGICA DO FIREBASE (NOVA) =========== -->
    // ================================================================= -->
    const firebaseConfig = {
        apiKey: "AIzaSyCW7zwtfMrZoOOJyej91wA1lj9d4wOgpMs",
        authDomain: "minha-ferramenta-gestao.firebaseapp.com",
        projectId: "minha-ferramenta-gestao",
        storageBucket: "minha-ferramenta-gestao.appspot.com", // corrigido de firebasestorage.app para appspot.com
        messagingSenderId: "254947115295",
        appId: "1:254947115295:web:b5d2ac3611df92ca21702a"
    };

    // Inicializa o Firebase
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    let currentUser = null; // Variável global para guardar o usuário logado


    // ================================================================= -->
    // ===================== CÓDIGO DA APLICAÇÃO ======================= -->
    // ================================================================= -->

    // --- DATA MOCKING (Default data for first-time use) ---
    const defaultData = {
        products: [
            { sku: 'NB-001', name: 'Notebook Pro 15"', category: 'Eletrônicos', qty: 15, color: 'Prata', cost: 4500, price: 7000, minStock: 10 },
            { sku: 'SM-002', name: 'Smartphone X', category: 'Eletrônicos', qty: 8, color: 'Preto', cost: 2000, price: 3500, minStock: 15 },
            { sku: 'CD-003', name: 'Cadeira Gamer', category: 'Móveis', qty: 30, color: 'Vermelho', cost: 800, price: 1500, minStock: 20 },
            { sku: 'MS-004', name: 'Mouse Sem Fio', category: 'Acessórios', qty: 50, color: 'Branco', cost: 80, price: 150, minStock: 30 }
        ],
        clients: [ { id: 'CLI-001', name: 'João Silva', email: 'joao@example.com', phone: '11987654321' } ],
        suppliers: [ { id: 'FOR-001', name: 'Atacado Eletrônicos', contact: 'Carlos', phone: '1155551234' } ],
        transactions: [
            { id: 'TRN-1', date: '2025-07-01', description: 'Venda de 2 Notebooks', category: 'Vendas', type: 'Receita', value: 14000, productSku: 'NB-001', qty: 2, status: 'Recebido', clientId: 'CLI-001' },
            { id: 'TRN-2', date: '2025-08-05', description: 'Pagamento de Aluguel', category: 'Aluguel', type: 'Despesa', value: 2500, productSku: '', qty: 0, status: 'A Pagar' },
            { id: 'TRN-3', date: '2025-06-20', description: 'Compra de Estoque - Mouses', category: 'Produto (Compra de Estoque)', type: 'Despesa', value: 800, productSku: 'MS-004', qty: 10, status: 'Pago' },
            { id: 'TRN-4', date: '2025-07-15', description: 'Venda Smartphone', category: 'Vendas', type: 'Receita', value: 3500, productSku: 'SM-002', qty: 1, status: 'A Receber', clientId: 'CLI-001' }
        ],
        receivables: [] // New array for tracking outstanding client payments
    };
    
    // --- STATE MANAGEMENT ---
    let state = {}; // O estado agora começa vazio e é carregado do Firestore
    let editingId = null; 
    let currentFilterStartDate = null;
    let currentFilterEndDate = null;
    let currentFinanceFilterStartDate = null;
    let currentFinanceFilterEndDate = null;
    // Predefined financial categories
    const financialCategories = {
        'Receita': ['Vendas', 'Serviços', 'Outras Receitas'],
        'Despesa': ['Produto (Compra de Estoque)', 'Marketing', 'Matéria Prima', 'Aluguel', 'Salários', 'Impostos', 'Transporte', 'Manutenção', 'Outras Despesas']
    };
    // --- DOM ELEMENTS CACHE ---
    const dom = {
        loginContainer: document.getElementById('login-container'),
        mainAppContainer: document.querySelector('.main-container'),
        loginBtn: document.getElementById('login-btn'),
        logoutBtn: document.getElementById('logout-btn'),
        loginError: document.getElementById('login-error'),
        // Modals & Panels
        modal: document.getElementById('modal'),
        modalTitle: document.getElementById('modal-title'),
        modalBody: document.getElementById('modal-body'),
        modalCloseBtn: document.getElementById('modal-close-btn'),
        notifications: {
            bell: document.getElementById('notifications-bell'),
            count: document.getElementById('notification-count'),
            panel: document.getElementById('notifications-panel'),
        },
        // Navigation
        nav: {
            overview: document.getElementById('nav-overview'), stock: document.getElementById('nav-stock'),
            cashflow: document.getElementById('nav-cashflow'), finance: document.getElementById('nav-finance'),
            receivables: document.getElementById('nav-receivables'),
            reports: document.getElementById('nav-reports'), entities: document.getElementById('nav-entities'),
            reportsDropdown: document.getElementById('reports-dropdown'),
        },
        // Content Sections
        content: {
            overview: document.getElementById('content-overview'), stock: document.getElementById('content-stock'),
            cashflow: document.getElementById('content-cashflow'), finance: document.getElementById('content-finance'),
            receivables: document.getElementById('content-receivables'),
            entities: document.getElementById('content-entities'),
        },
        // KPIs
        kpi: {
            stockValue: document.getElementById('kpi-stock-value'), lowStock: document.getElementById('kpi-low-stock'),
            balance: document.getElementById('kpi-balance'), profit: document.getElementById('kpi-profit'),
            totalReceivables: document.getElementById('kpi-total-receivables') // New KPI
        },
        // Report Links
        reportLinks: {
            abc: document.getElementById('report-abc'), dre: document.getElementById('report-dre'),
        },
        // Misc
        dashboardPeriod: document.getElementById('dashboard-period'),
        customDateRange: document.getElementById('custom-date-range'),
        startDate: document.getElementById('start-date'),
        endDate: document.getElementById('end-date'),
        applyCustomRange: document.getElementById('apply-custom-range'),
        financePeriod: document.getElementById('finance-period'),
        customFinanceDateRange: document.getElementById('custom-finance-date-range'),
        financeStartDate: document.getElementById('finance-start-date'),
        financeEndDate: document.getElementById('finance-end-date'),
        applyFinanceCustomRange: document.getElementById('apply-finance-custom-range'),
        themeToggle: document.getElementById('theme-toggle'),
        stockAdjustBtn: document.getElementById('stock-adjust-btn'),
        csvUpload: document.getElementById('csv-upload'),
        addProductBtn: document.getElementById('add-product-btn'),
        productFormCard: document.getElementById('product-form-card'),
        productFormTitle: document.getElementById('product-form-title'),
        productForm: document.getElementById('product-form'),
        addTransactionBtn: document.getElementById('add-transaction-btn'),
        transactionFormCard: document.getElementById('transaction-form-card'),
        transactionFormTitle: document.getElementById('transaction-form-title'),
        transactionForm: document.getElementById('transaction-form'),
        addClientBtn: document.getElementById('add-client-btn'),
        addSupplierBtn: document.getElementById('add-supplier-btn'),
        entityFormCard: document.getElementById('entity-form-card'),
        entityFormTitle: document.getElementById('entity-form-title'),
        entityForm: document.getElementById('entity-form'),
    };
    
    // --- LÓGICA DE AUTENTICAÇÃO PRINCIPAL (NOVA) ---
    auth.onAuthStateChanged(user => {
        if (user) {
            // Usuário está LOGADO
            currentUser = user; 
            dom.loginContainer.style.display = 'none';
            dom.mainAppContainer.style.display = 'block';
            
            loadDataFromFirestore(); // Carrega os dados do usuário e inicia a app
        } else {
            // Usuário está DESLOGADO
            currentUser = null;
            dom.loginContainer.style.display = 'flex';
            dom.mainAppContainer.style.display = 'none';
        }
    });

    // --- NOVAS FUNÇÕES DE DADOS (FIRESTORE) ---
    const saveData = () => {
        if (!currentUser) return;
        const userDocRef = db.collection('users').doc(currentUser.uid);
        
        userDocRef.set(state)
            .then(() => console.log("Dados salvos no Firestore!"))
            .catch(error => console.error("Erro ao salvar dados: ", error));
    };

    const loadDataFromFirestore = () => {
        if (!currentUser) return;
        const userDocRef = db.collection('users').doc(currentUser.uid);

        userDocRef.get().then(doc => {
            if (doc.exists) {
                // Se o usuário já tem dados salvos, carrega-os para o 'state'
                state = doc.data();
                // Garante que todos os arrays existam para evitar erros
                state.products = state.products || [];
                state.clients = state.clients || [];
                state.suppliers = state.suppliers || [];
                state.transactions = state.transactions || [];
                state.receivables = state.receivables || [];
            } else {
                // Se for um novo usuário, usa o estado padrão e salva
                console.log("Novo usuário, iniciando com dados padrão.");
                state = JSON.parse(JSON.stringify(defaultData)); 
                saveData(); // Salva os dados iniciais no Firestore
            }
            initApp(); // Inicia a renderização e os event listeners
        }).catch(error => {
            console.error("Erro ao carregar dados:", error);
        });
    };

    // --- FUNÇÕES DA APLICAÇÃO (A MAIORIA JÁ EXISTIA) ---
    const formatCurrency = (value) => new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(value || 0);
    const formatDate = (dateStr) => {
        if (!dateStr) return '';
        const date = new Date(dateStr);
        const year = date.getUTCFullYear();
        const month = (date.getUTCMonth() + 1).toString().padStart(2, '0');
        const day = date.getUTCDate().toString().padStart(2, '0');
        return `${day}/${month}/${year}`;
    }
    const formatDateForInput = (dateStr) => {
        if (!dateStr) return '';
        return new Date(dateStr).toISOString().split('T')[0];
    }
    const generateId = (prefix) => `${prefix}-${Math.random().toString(36).substr(2, 6).toUpperCase()}`;
    const showModal = (title, content) => {
        dom.modalTitle.innerHTML = title;
        dom.modalBody.innerHTML = content;
        dom.modal.classList.remove('hidden');
    };
    const hideModal = () => dom.modal.classList.add('hidden');
    const updateNotifications = () => {
        const lowStockItems = state.products.filter(p => p.qty < p.minStock);
        const pendingTransactions = state.transactions.filter(t => ['A Pagar', 'A Receber'].includes(t.status));
        const overdueReceivables = state.receivables.filter(r => r.status !== 'Pago' && r.dueDate && new Date(r.dueDate) < new Date());
        let notifications = [];
        if (lowStockItems.length > 0) notifications.push({ text: `${lowStockItems.length} produto(s) com estoque baixo.`, type: 'stock' });
        if (pendingTransactions.length > 0) notifications.push({ text: `${pendingTransactions.length} transação(ões) de contas a pagar/receber pendente(s).`, type: 'finance' });
        state.receivables.forEach(r => {
            if (r.status !== 'Pago' && r.purchaseDate) {
                const purchaseDate = new Date(r.purchaseDate);
                const oneMonthLater = new Date(purchaseDate);
                oneMonthLater.setMonth(oneMonthLater.getMonth() + 1);
                if (new Date() >= oneMonthLater && !r.alerted) {
                    const client = state.clients.find(c => c.id === r.clientId);
                    const valueDue = r.originalAmount - r.amountPaid - r.discountAmount;
                    notifications.push({ text: `Cliente ${client ? client.name : 'N/A'} (ID: ${r.clientId}) tem dívida de ${formatCurrency(valueDue)} a 1 mês.`, type: 'receivables' });
                    r.alerted = true; 
                }
            }
        });
        if (overdueReceivables.length > 0) notifications.push({ text: `${overdueReceivables.length} valor(es) a receber em atraso!`, type: 'receivables' });
        if (notifications.length > 0) {
            dom.notifications.count.textContent = notifications.length;
            dom.notifications.count.classList.remove('hidden');
            dom.notifications.panel.innerHTML = notifications.map(n => `<div class="notification-item cursor-pointer" data-type="${n.type}">${n.text}</div>`).join('');
            dom.notifications.panel.querySelectorAll('.notification-item').forEach(item => {
                item.addEventListener('click', (e) => {
                    const type = e.target.dataset.type;
                    if (type === 'stock') switchTab('stock');
                    else if (type === 'finance') switchTab('finance');
                    else if (type === 'receivables') switchTab('receivables');
                    dom.notifications.panel.classList.add('hidden');
                });
            });
        } else {
            dom.notifications.count.classList.add('hidden');
            dom.notifications.panel.innerHTML = '<div class="notification-item">Nenhuma notificação nova.</div>';
        }
    };
    
    // REMOVIDO: saveData e loadData que usavam localStorage
    
    const applyTheme = (theme) => {
        document.documentElement.setAttribute('data-theme', theme);
        dom.themeToggle.innerHTML = theme === 'dark' ? '<i class="fas fa-sun"></i>' : '<i class="fas fa-moon"></i>';
        localStorage.setItem('gestao5.0_theme', theme);
    };
    const toggleTheme = () => {
        const currentTheme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
        applyTheme(currentTheme);
        renderAll();
    };
    const switchTab = (tabName) => {
        Object.values(dom.nav).forEach(btn => {
            if (btn && typeof btn === 'object' && btn.classList) {
                btn.classList.remove('active');
            }
        });
        Object.values(dom.content).forEach(sec => sec.classList.add('hidden'));
        if (dom.nav[tabName]) {
            dom.nav[tabName].classList.add('active');
        }
        if (dom.content[tabName]) {
            dom.content[tabName].classList.remove('hidden');
        }
        dom.productFormCard.classList.add('hidden');
        dom.transactionFormCard.classList.add('hidden');
        dom.entityFormCard.classList.add('hidden');
        editingId = null; 
        if (tabName === 'finance') {
            renderFinancialTables();
            renderFinanceChart();
        }
        if (tabName === 'receivables') {
            renderReceivablesTable();
        }
    };
    const processTransactions = () => {
        state.transactions.forEach(t => {
            if (t.type === 'Receita' && t.productSku) {
                const product = state.products.find(p => p.sku === t.productSku);
                if (product) {
                    t.cost = product.cost * t.qty;
                    t.profit = t.value - t.cost; 
                }
            } else if (t.type === 'Despesa' && t.productSku && t.category === 'Produto (Compra de Estoque)') {
                const product = state.products.find(p => p.sku === t.productSku);
                if (product) {
                    t.cost = t.value;
                    t.profit = 0;
                }
            } else {
                t.cost = 0;
                t.profit = 0;
            }
        });
    };
    const getFilteredTransactions = (periodType = 'dashboard') => {
        const period = periodType === 'dashboard' ? dom.dashboardPeriod.value : dom.financePeriod.value;
        let startDate = periodType === 'dashboard' ? currentFilterStartDate : currentFinanceFilterStartDate;
        let endDate = periodType === 'dashboard' ? currentFilterEndDate : currentFinanceFilterEndDate;
        if (period === 'all') return state.transactions;
        const now = new Date();
        if (period !== 'custom') {
            startDate = new Date();
            endDate = new Date();
            if (period === '30') startDate.setDate(now.getDate() - 30);
            else if (period === '90') startDate.setDate(now.getDate() - 90);
            else if (period === 'month') startDate = new Date(now.getFullYear(), now.getMonth(), 1);
            else if (period === 'year') startDate = new Date(now.getFullYear(), 0, 1);
        }
        if (!startDate || !endDate) return state.transactions; 
        startDate.setHours(0, 0, 0, 0);
        endDate.setHours(23, 59, 59, 999);
        return state.transactions.filter(t => {
            const transactionDate = new Date(t.date);
            return transactionDate >= startDate && transactionDate <= endDate;
        });
    };
    let revenueExpenseChart;
    let financeRevenueExpenseChart;
    const renderDashboard = () => {
        const filteredTransactions = getFilteredTransactions('dashboard');
        const stockValue = state.products.reduce((acc, p) => acc + (p.qty * p.cost), 0);
        const lowStockItems = state.products.filter(p => p.qty < p.minStock).length;
        const balance = filteredTransactions.reduce((acc, t) => {
            if(t.status === 'Pago' || t.status === 'Recebido') {
               return acc + (t.type === 'Receita' ? t.value : -t.value);
            }
            return acc;
        }, 0);
        const profit = filteredTransactions.reduce((acc, t) => acc + (t.profit || 0), 0);
        const totalReceivablesValue = state.receivables.reduce((acc, r) => {
            if (r.status !== 'Pago') {
                return acc + (r.originalAmount - r.amountPaid - r.discountAmount);
            }
            return acc;
        }, 0);
        dom.kpi.stockValue.textContent = formatCurrency(stockValue);
        dom.kpi.lowStock.textContent = lowStockItems;
        dom.kpi.balance.textContent = formatCurrency(balance);
        dom.kpi.profit.textContent = formatCurrency(profit);
        dom.kpi.totalReceivables.textContent = formatCurrency(totalReceivablesValue);
        const ctx = document.getElementById('revenueExpenseChart').getContext('2d');
        const labels = [...new Set(filteredTransactions.map(t => formatDate(t.date)))].sort((a,b) => {
            const [dayA, monthA, yearA] = a.split('/').map(Number);
            const [dayB, monthB, yearB] = b.split('/').map(Number);
            return new Date(yearA, monthA -1, dayA) - new Date(yearB, monthB -1, dayB);
        });
        const revenues = labels.map(label => filteredTransactions.filter(t => formatDate(t.date) === label && t.type === 'Receita').reduce((sum, t) => sum + t.value, 0));
        const expenses = labels.map(label => filteredTransactions.filter(t => formatDate(t.date) === label && t.type === 'Despesa').reduce((sum, t) => sum + t.value, 0));
        const theme = document.documentElement.getAttribute('data-theme');
        const gridColor = theme === 'dark' ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';
        if (revenueExpenseChart) revenueExpenseChart.destroy();
        revenueExpenseChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels,
                datasets: [
                    { label: 'Receitas', data: revenues, backgroundColor: '#16a34a' },
                    { label: 'Despesas', data: expenses, backgroundColor: '#dc2626' }
                ]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                scales: { y: { ticks: { color: theme === 'dark' ? '#fff' : '#000' }, grid: { color: gridColor } }, x: { ticks: { color: theme ==='dark' ? '#fff' : '#000' }, grid: { color: gridColor } } }
            }
        });
    };
    const renderFinanceChart = () => {
        const filteredTransactions = getFilteredTransactions('finance');
        const ctx = document.getElementById('financeRevenueExpenseChart').getContext('2d');
        const labels = [...new Set(filteredTransactions.map(t => formatDate(t.date)))].sort((a,b) => {
            const [dayA, monthA, yearA] = a.split('/').map(Number);
            const [dayB, monthB, yearB] = b.split('/').map(Number);
            return new Date(yearA, monthA -1, dayA) - new Date(yearB, monthB -1, dayB);
        });
        const revenues = labels.map(label => filteredTransactions.filter(t => formatDate(t.date) === label && t.type === 'Receita').reduce((sum, t) => sum + t.value, 0));
        const expenses = labels.map(label => filteredTransactions.filter(t => formatDate(t.date) === label && t.type === 'Despesa').reduce((sum, t) => sum + t.value, 0));
        const theme = document.documentElement.getAttribute('data-theme');
        const gridColor = theme === 'dark' ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';
        if (financeRevenueExpenseChart) financeRevenueExpenseChart.destroy();
        financeRevenueExpenseChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels,
                datasets: [
                    { label: 'Receitas', data: revenues, borderColor: '#16a34a', fill: false },
                    { label: 'Despesas', data: expenses, borderColor: '#dc2626', fill: false }
                ]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                scales: { y: { ticks: { color: theme === 'dark' ? '#fff' : '#000' }, grid: { color: gridColor } }, x: { ticks: { color: theme ==='dark' ? '#fff' : '#000' }, grid: { color: gridColor } } }
            }
        });
    };
    const renderProductsTable = () => {
        const tbody = document.querySelector('#products-table tbody');
        tbody.innerHTML = state.products.map(p => `
            <tr>
                <td>${p.sku}</td><td>${p.name}</td><td>${p.qty}</td><td>${p.color || ''}</td>
                <td>${formatCurrency(p.cost)}</td><td>${formatCurrency(p.price)}</td>
                <td><span class="status-badge ${p.qty < p.minStock ? 'status-low' : 'status-ok'}">${p.qty < p.minStock ? 'Baixo' : 'OK'}</span></td>
                <td>
                    <button class="btn-secondary text-xs" onclick="window.app.showProductHistory('${p.sku}')"><i class="fas fa-history"></i></button>
                    <button class="btn-secondary text-xs" onclick="window.app.editItem('product', '${p.sku}')"><i class="fas fa-edit"></i></button>
                    <button class="btn-delete text-xs" onclick="window.app.deleteItem('product', '${p.sku}')"><i class="fas fa-trash"></i></button>
                </td>
            </tr>`).join('');
    };
    const renderTransactionsTable = () => {
        const tbody = document.querySelector('#transactions-table tbody');
        tbody.innerHTML = [...state.transactions].sort((a, b) => new Date(b.date) - new Date(a.date)).map(t => {
            const client = t.clientId ? state.clients.find(c => c.id === t.clientId) : null;
            const entityName = client ? client.name : 'N/A';
            return `
                <tr>
                    <td>${formatDate(t.date)}</td>
                    <td>${t.description}</td>
                    <td>${entityName}</td>
                    <td class="${t.type === 'Receita' ? 'text-green-600' : 'text-red-600'}">${t.type}</td>
                    <td class="font-semibold">${formatCurrency(t.value)}</td>
                    <td>${t.status}</td>
                    <td>
                        <button class="btn-secondary text-xs" onclick="window.app.editItem('transaction', '${t.id}')"><i class="fas fa-edit"></i></button>
                        <button class="btn-delete text-xs" onclick="window.app.deleteItem('transaction', '${t.id}')"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>`;
        }).join('');
    };
    const renderFinancialTables = () => {
        const payableBody = document.querySelector('#payable-table tbody');
        payableBody.innerHTML = state.transactions
            .filter(t => t.status === 'A Pagar').sort((a,b) => new Date(a.date) - new Date(b.date))
            .map(t => `<tr><td>${formatDate(t.date)}</td><td>${t.description}</td><td>${formatCurrency(t.value)}</td></tr>`).join('');
        const receivableBody = document.querySelector('#receivable-table tbody');
        receivableBody.innerHTML = state.transactions
            .filter(t => t.status === 'A Receber').sort((a,b) => new Date(a.date) - new Date(b.date))
            .map(t => `<tr><td>${formatDate(t.date)}</td><td>${t.description}</td><td>${formatCurrency(t.value)}</td></tr>`).join('');
    };
    const renderReceivablesTable = () => {
        const tbody = document.querySelector('#client-receivables-table tbody');
        tbody.innerHTML = state.receivables.filter(r => r.status !== 'Pago').map(r => {
            const client = state.clients.find(c => c.id === r.clientId);
            const product = r.productSku ? state.products.find(p => p.sku === r.productSku) : null;
            const valueDue = r.originalAmount - r.amountPaid - r.discountAmount;
            const statusClass = new Date(r.dueDate) < new Date() && valueDue > 0 ? 'text-red-500 font-bold' : '';
            const statusText = valueDue <= 0 ? 'Pago' : (new Date(r.dueDate) < new Date() && valueDue > 0 ? 'Atrasado' : 'Pendente');
            return `
                <tr>
                    <td>${formatDate(r.purchaseDate)}</td>
                    <td>${client ? client.name : 'N/A'}</td>
                    <td>${r.description || product?.name || 'N/A'}</td>
                    <td>${formatCurrency(r.originalAmount)}</td>
                    <td>${formatCurrency(r.amountPaid)}</td>
                    <td>${formatCurrency(r.discountAmount)}</td>
                    <td class="${statusClass}">${formatCurrency(valueDue)}</td>
                    <td>${statusText}</td>
                    <td>
                        <button class="btn-secondary text-xs" onclick="window.app.showAmortizationForm('${r.id}')"><i class="fas fa-hand-holding-usd"></i> Amortizar</button>
                        <button class="btn-secondary text-xs" onclick="window.app.showDiscountForm('${r.id}')"><i class="fas fa-percent"></i> Desconto</button>
                    </td>
                </tr>
            `;
        }).join('');
    };
    const renderClientsTable = () => {
        const tbody = document.querySelector('#clients-table tbody');
        tbody.innerHTML = state.clients.map(c => `
            <tr>
                <td>${c.id}</td><td>${c.name}</td><td>${c.email || c.phone}</td>
                <td><button class="btn-secondary text-xs" onclick="window.app.editItem('client', '${c.id}')"><i class="fas fa-edit"></i></button>
                <button class="btn-delete text-xs" onclick="window.app.deleteItem('client', '${c.id}')"><i class="fas fa-trash"></i></button></td>
            </tr>`).join('');
    };
    const renderSuppliersTable = () => {
        const tbody = document.querySelector('#suppliers-table tbody');
        tbody.innerHTML = state.suppliers.map(s => `
            <tr>
                <td>${s.id}</td><td>${s.name}</td><td>${s.contact || s.phone}</td>
                <td><button class="btn-secondary text-xs" onclick="window.app.editItem('supplier', '${s.id}')"><i class="fas fa-edit"></i></button>
                <button class="btn-delete text-xs" onclick="window.app.deleteItem('supplier', '${s.id}')"><i class="fas fa-trash"></i></button></td>
            </tr>`).join('');
    };
    const renderABCReport = () => {
        let productSales = {};
        state.transactions.filter(t => t.type === 'Receita' && t.productSku).forEach(t => {
            productSales[t.productSku] = (productSales[t.productSku] || 0) + t.value;
        });
        const sortedProducts = Object.keys(productSales).map(sku => ({
            sku,
            name: state.products.find(p => p.sku === sku)?.name || 'N/A',
            revenue: productSales[sku]
        })).sort((a, b) => b.revenue - a.revenue);
        const totalRevenue = sortedProducts.reduce((sum, p) => sum + p.revenue, 0);
        let cumulativeRevenue = 0;
        const classifiedProducts = sortedProducts.map(p => {
            cumulativeRevenue += p.revenue;
            const cumulativePercent = (cumulativeRevenue / totalRevenue) * 100;
            let classification = 'C';
            if (cumulativePercent <= 80) classification = 'A';
            else if (cumulativePercent <= 95) classification = 'B';
            return { ...p, classification };
        });
        const tableRows = classifiedProducts.map(p => `
            <tr>
                <td class="font-bold text-center">${p.classification}</td>
                <td>${p.name}</td>
                <td>${formatCurrency(p.revenue)}</td>
            </tr>
        `).join('');
        showModal('Relatório: Curva ABC de Produtos', `
            <p class="mb-4">Classifica os produtos por relevância de faturamento. Foco nos produtos "A"!</p>
            <table class="w-full">
                <thead><tr><th class="w-1/6">Classe</th><th>Produto</th><th>Faturamento</th></tr></thead>
                <tbody>${tableRows}</tbody>
            </table>
        `);
    };
    const renderDRE = () => {
        const tx = getFilteredTransactions('dashboard');
        const totalRevenue = tx.filter(t => t.type === 'Receita').reduce((sum, t) => sum + t.value, 0);
        const cmv = tx.filter(t => t.type === 'Receita').reduce((sum, t) => sum + (t.cost || 0), 0);
        const grossProfit = totalRevenue - cmv;
        const expenses = tx.filter(t => t.type === 'Despesa' && t.category !== 'Produto (Compra de Estoque)').reduce((sum, t) => sum + t.value, 0);
        const netIncome = grossProfit - expenses;
        const content = `
            <div class="space-y-2 text-lg">
                <div class="flex justify-between"><span>(+) Receita Operacional Bruta</span> <span>${formatCurrency(totalRevenue)}</span></div>
                <div class="flex justify-between"><span>(-) Custo da Mercadoria Vendida (CMV)</span> <span>${formatCurrency(cmv)}</span></div>
                <hr class="my-2 border-gray-500">
                <div class="flex justify-between font-bold"><span>(=) Lucro Bruto</span> <span>${formatCurrency(grossProfit)}</span></div>
                <div class="flex justify-between mt-4"><span>(-) Despesas Operacionais</span> <span>${formatCurrency(expenses)}</span></div>
                <hr class="my-2 border-gray-500">
                <div class="flex justify-between font-bold text-2xl ${netIncome >= 0 ? 'text-green-500' : 'text-red-500'}"><span>(=) Resultado Líquido</span> <span>${formatCurrency(netIncome)}</span></div>
            </div>
        `;
        showModal('DRE - Demonstrativo de Resultado', content);
    };
    const renderAll = () => {
        processTransactions();
        renderDashboard();
        renderProductsTable();
        renderTransactionsTable();
        renderFinancialTables();
        renderReceivablesTable();
        renderClientsTable();
        renderSuppliersTable();
        updateNotifications();
    };

    // --- CRUD & ACTIONS ---
    const app = {
        showProductHistory: (sku) => {
            const product = state.products.find(p => p.sku === sku);
            const history = state.transactions
                .filter(t => t.productSku === sku && (t.type === 'Receita' || t.category === 'Produto (Compra de Estoque)' || t.category === 'Ajuste'))
                .sort((a,b) => new Date(b.date) - new Date(a.date))
                .map(t => {
                    let qtyChange = 0;
                    let operation = '';
                    if (t.type === 'Receita') {
                        qtyChange = -t.qty;
                        operation = 'Venda';
                    } else if (t.category === 'Produto (Compra de Estoque)') {
                        qtyChange = t.qty;
                        operation = 'Compra';
                    } else if (t.category === 'Ajuste') {
                        qtyChange = t.qty;
                        operation = 'Ajuste';
                    }
                    return `
                        <tr>
                            <td>${formatDate(t.date)}</td>
                            <td>${operation}: ${t.description}</td>
                            <td class="${qtyChange < 0 ? 'text-red-500' : 'text-green-500'}">${qtyChange > 0 ? '+' : ''}${qtyChange}</td>
                        </tr>
                    `;
                }).join('');
            showModal(`Histórico: ${product.name}`, `
                <table class="w-full"><thead><tr><th>Data</th><th>Operação</th><th>Qtd.</th></tr></thead><tbody>${history}</tbody></table>
            `);
        },
        deleteItem: (type, id) => {
            if (!confirm(`Tem certeza que deseja deletar este ${type}?`)) return;
            if (type === 'product') {
                state.products = state.products.filter(p => p.sku !== id);
            } else if (type === 'transaction') {
                state.transactions = state.transactions.filter(t => t.id !== id);
            } else if (type === 'client') {
                state.clients = state.clients.filter(c => c.id !== id);
                state.receivables = state.receivables.filter(r => r.clientId !== id);
            } else if (type === 'supplier') {
                state.suppliers = state.suppliers.filter(s => s.id !== id);
            } else if (type === 'receivable') {
                state.receivables = state.receivables.filter(r => r.id !== id);
            }
            saveData();
            renderAll();
        },
        // ... (o restante de todas as funções do objeto 'app' permanece o mesmo, sem alterações)
        // ... (editItem, showProductForm, handleStockAdjustment, handleCsvImport, showTransactionForm, etc.)
        // ... (Vou colar o resto aqui para garantir que esteja completo)
        editItem: (type, id) => {
                editingId = id;
                if (type === 'product') {
                    const product = state.products.find(p => p.sku === id);
                    app.showProductForm(product);
                } else if (type === 'transaction') {
                    const transaction = state.transactions.find(t => t.id === id);
                    app.showTransactionForm(transaction);
                } else if (type === 'client') {
                    const client = state.clients.find(c => c.id === id);
                    app.showEntityForm('client', client);
                } else if (type === 'supplier') {
                    const supplier = state.suppliers.find(s => s.id === id);
                    app.showEntityForm('supplier', supplier);
                }
            },
            showProductForm: (product = null) => {
                dom.productFormCard.classList.remove('hidden');
                dom.productFormTitle.textContent = product ? 'Editar Produto' : 'Adicionar Novo Produto';
                dom.productForm.innerHTML = `
                    <div class="form-group"><label for="product-sku">SKU (Opcional):</label><input type="text" id="product-sku" value="${product ? product.sku : ''}" ${product ? 'readonly' : ''}></div>
                    <div class="form-group"><label for="product-name">Nome:</label><input type="text" id="product-name" value="${product ? product.name : ''}" required></div>
                    <div class="form-group"><label for="product-category">Categoria:</label><input type="text" id="product-category" value="${product ? product.category : ''}" required></div>
                    <div class="form-group"><label for="product-color">Cor:</label><input type="text" id="product-color" value="${product ? product.color || '' : ''}"></div>
                    <div class="form-group"><label for="product-qty">Quantidade:</label><input type="number" id="product-qty" value="${product ? product.qty : 0}" required min="0"></div>
                    <div class="form-group"><label for="product-cost">Custo:</label><input type="number" id="product-cost" value="${product ? product.cost : 0}" step="0.01" required min="0"></div>
                    <div class="form-group"><label for="product-price">Preço de Venda:</label><input type="number" id="product-price" value="${product ? product.price : 0}" step="0.01" required min="0"></div>
                    <div class="form-group"><label for="product-minStock">Estoque Mínimo:</label><input type="number" id="product-minStock" value="${product ? product.minStock : 0}" required min="0"></div>
                    <button type="submit" class="btn-primary w-full">${product ? 'Salvar Alterações' : 'Adicionar Produto'}</button>
                `;
                dom.productForm.onsubmit = (e) => {
                    e.preventDefault();
                    let sku = document.getElementById('product-sku').value.trim();
                    if (!sku) {
                        sku = generateId('PROD');
                    } else if (!product && state.products.some(p => p.sku === sku)) {
                        alert('SKU já existe. Por favor, insira um SKU único ou deixe em branco para gerar automaticamente.');
                        return;
                    }
                    const newProduct = {
                        sku: sku,
                        name: document.getElementById('product-name').value.trim(),
                        category: document.getElementById('product-category').value.trim(),
                        color: document.getElementById('product-color').value.trim(),
                        qty: parseInt(document.getElementById('product-qty').value),
                        cost: parseFloat(document.getElementById('product-cost').value),
                        price: parseFloat(document.getElementById('product-price').value),
                        minStock: parseInt(document.getElementById('product-minStock').value),
                    };
                    if (product) {
                        Object.assign(product, newProduct);
                    } else {
                        state.products.push(newProduct);
                    }
                    saveData();
                    renderAll();
                    dom.productFormCard.classList.add('hidden');
                    editingId = null;
                };
            },
            handleStockAdjustment: () => {
                const productOptions = state.products.map(p => `<option value="${p.sku}">${p.name} (Qtd atual: ${p.qty})</option>`).join('');
                const formHtml = `
                    <form id="stock-adjust-form" class="space-y-4">
                        <div class="form-group"><label for="adj-product">Produto:</label><select id="adj-product" class="form-group select" required>${productOptions}</select></div>
                        <div class="form-group"><label for="adj-qty">Nova Quantidade Total:</label><input type="number" id="adj-qty" required min="0"></div>
                        <div class="form-group"><label for="adj-reason">Motivo:</label><input type="text" id="adj-reason" placeholder="Ex: Contagem de inventário, perda" required></div>
                        <button type="submit" class="btn-primary w-full">Confirmar Ajuste</button>
                    </form>
                `;
                showModal('Ajuste Manual de Estoque', formHtml);
                
                document.getElementById('stock-adjust-form').addEventListener('submit', e => {
                    e.preventDefault();
                    const sku = document.getElementById('adj-product').value;
                    const newQty = parseInt(document.getElementById('adj-qty').value);
                    const reason = document.getElementById('adj-reason').value;
                    const product = state.products.find(p => p.sku === sku);
                    
                    if (product) {
                        const qtyChange = newQty - product.qty;
                        product.qty = newQty;
                        state.transactions.push({
                            id: generateId('LOG'),
                            date: new Date().toISOString().split('T')[0],
                            description: `Ajuste de estoque: ${reason}`,
                            category: 'Ajuste', type: 'Log', value: 0,
                            productSku: sku, qty: qtyChange, status: 'Concluído'
                        });
                        saveData();
                        renderAll();
                        hideModal();
                    }
                });
            },
            handleCsvImport: (event) => {
                const file = event.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    const text = e.target.result;
                    const lines = text.split('\n').slice(1);
                    let importedCount = 0;
                    lines.forEach(line => {
                        const [sku, name, category, qty, cost, price, minStock, color] = line.split(',');
                        if (sku && name && !state.products.some(p => p.sku === sku.trim())) {
                            state.products.push({
                                sku: sku.trim(), name: name.trim(), category: category.trim(),
                                qty: parseInt(qty), cost: parseFloat(cost), price: parseFloat(price), minStock: parseInt(minStock),
                                color: color ? color.trim() : ''
                            });
                            importedCount++;
                        }
                    });
                    alert(`${importedCount} produtos importados com sucesso!`);
                    saveData();
                    renderAll();
                };
                reader.readAsText(file);
            },
            showTransactionForm: (transaction = null) => {
                dom.transactionFormCard.classList.remove('hidden');
                dom.transactionFormTitle.textContent = transaction ? 'Editar Transação' : 'Registrar Nova Transação';
                const productOptions = state.products.map(p => `<option value="${p.sku}" data-price="${p.price}" data-cost="${p.cost}" data-qty="${p.qty}">${p.name} (Qtd: ${p.qty})</option>`).join('');
                const clientOptions = state.clients.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
                dom.transactionForm.innerHTML = `
                    <div class="form-group"><label for="trn-date">Data:</label><input type="date" id="trn-date" value="${transaction ? formatDateForInput(transaction.date) : new Date().toISOString().split('T')[0]}" required></div>
                    <div class="form-group"><label for="trn-description">Descrição (Opcional):</label><input type="text" id="trn-description" value="${transaction ? transaction.description : ''}"></div>
                    <div class="form-group"><label for="trn-type">Tipo:</label><select id="trn-type" class="form-group select" required>
                        <option value="Receita" ${transaction && transaction.type === 'Receita' ? 'selected' : ''}>Receita</option>
                        <option value="Despesa" ${transaction && transaction.type === 'Despesa' ? 'selected' : ''}>Despesa</option>
                    </select></div>
                    <div class="form-group"><label for="trn-category">Categoria:</label><select id="trn-category" class="form-group select" required>
                        </select></div>
                    <div class="form-group" id="product-selection-group" style="display:none;">
                        <label for="trn-product-sku">Produto:</label>
                        <select id="trn-product-sku" class="form-group select">
                            <option value="">Selecione um produto</option>
                            ${productOptions}
                        </select>
                        <label for="trn-qty">Quantidade:</label>
                        <input type="number" id="trn-qty" value="${transaction ? transaction.qty : 1}" min="1">
                        <p id="current-stock-info" class="text-sm text-gray-500"></p>
                    </div>
                    <div class="form-group" id="client-id-group" style="display:none;">
                         <label for="trn-client-id">Cliente:</label>
                        <select id="trn-client-id" class="form-group select">
                            <option value="">Selecione um cliente (Opcional)</option>
                            ${clientOptions}
                        </select>
                    </div>
                    <div class="form-group"><label for="trn-base-value">Valor Base (Preço do Produto/Custo da Despesa):</label><input type="number" id="trn-base-value" value="${transaction ? transaction.originalValue || transaction.value : 0}" step="0.01" required min="0"></div>
                    <div id="sales-payment-section" style="display:none;">
                        <div class="form-group flex gap-2">
                            <div class="flex-1">
                                <label for="trn-discount-type">Tipo de Desconto:</label>
                                <select id="trn-discount-type" class="form-group select">
                                    <option value="none">Nenhum</option>
                                    <option value="percent">%</option>
                                    <option value="amount">R$</option>
                                </select>
                            </div>
                            <div class="flex-1">
                                <label for="trn-discount-value">Valor/Percentual Desconto:</label>
                                 <input type="number" id="trn-discount-value" value="0" step="0.01" min="0">
                            </div>
                        </div>
                        <div class="form-group"><label for="trn-total-after-discount">Total Líquido da Venda:</label><input type="number" id="trn-total-after-discount" value="0" step="0.01" readonly></div>
                        <div class="form-group"><label for="trn-amount-paid">Valor Pago pelo Cliente:</label><input type="number" id="trn-amount-paid" value="${transaction ? transaction.value : 0}" step="0.01" required min="0"></div>
                        <div class="form-group"><label for="trn-remaining-amount">Valor Restante a Pagar:</label><input type="number" id="trn-remaining-amount" value="0" step="0.01" readonly></div>
                    </div>
                    <div class="form-group"><label for="trn-status">Status:</label><select id="trn-status" class="form-group select" required>
                        <option value="A Pagar" ${transaction && transaction.status === 'A Pagar' ? 'selected' : ''}>A Pagar</option>
                        <option value="Pago" ${transaction && transaction.status === 'Pago' ? 'selected' : ''}>Pago</option>
                        <option value="A Receber" ${transaction && transaction.status === 'A Receber' ? 'selected' : ''}>A Receber</option>
                        <option value="Recebido" ${transaction && transaction.status === 'Recebido' ? 'selected' : ''}>Recebido</option>
                    </select></div>
                    <button type="submit" class="btn-primary w-full">${transaction ? 'Salvar Alterações' : 'Registrar Transação'}</button>
                `;
                const trnTypeSelect = document.getElementById('trn-type');
                const trnCategorySelect = document.getElementById('trn-category');
                const productSelectionGroup = document.getElementById('product-selection-group');
                const trnProductSku = document.getElementById('trn-product-sku');
                const trnQty = document.getElementById('trn-qty');
                const currentStockInfo = document.getElementById('current-stock-info');
                const clientIdGroup = document.getElementById('client-id-group');
                const trnClientId = document.getElementById('trn-client-id');
                const trnBaseValue = document.getElementById('trn-base-value');
                const salesPaymentSection = document.getElementById('sales-payment-section');
                const trnDiscountType = document.getElementById('trn-discount-type');
                const trnDiscountValue = document.getElementById('trn-discount-value');
                const trnTotalAfterDiscount = document.getElementById('trn-total-after-discount');
                const trnAmountPaid = document.getElementById('trn-amount-paid');
                const trnRemainingAmount = document.getElementById('trn-remaining-amount');
                const updateCategoryOptions = () => {
                    const selectedType = trnTypeSelect.value;
                    const categories = financialCategories[selectedType];
                    trnCategorySelect.innerHTML = categories.map(cat => `<option value="${cat}">${cat}</option>`).join('');
                    if (transaction && transaction.category) {
                        trnCategorySelect.value = transaction.category;
                    }
                    toggleDynamicFields();
                };
                
                if (transaction && trnProductSku && transaction.productSku) trnProductSku.value = transaction.productSku;
                if (transaction && trnClientId && transaction.clientId) trnClientId.value = transaction.clientId;
                if (transaction && transaction.discountType) trnDiscountType.value = transaction.discountType;
                if (transaction && transaction.discountValue) trnDiscountValue.value = transaction.discountValue;
                const calculateRemainingAmount = () => {
                    let baseVal = parseFloat(trnBaseValue.value) || 0;
                    let totalAfterDiscount = baseVal;
                    
                    const discountType = trnDiscountType.value;
                    const discountVal = parseFloat(trnDiscountValue.value) || 0;
                    if (discountType === 'percent') {
                        totalAfterDiscount = baseVal * (1 - (discountVal / 100));
                    } else if (discountType === 'amount') {
                        totalAfterDiscount = baseVal - discountVal;
                    }
                    if (totalAfterDiscount < 0) totalAfterDiscount = 0;
                    trnTotalAfterDiscount.value = totalAfterDiscount.toFixed(2);
                    const amountPaid = parseFloat(trnAmountPaid.value) || 0;
                    let remaining = totalAfterDiscount - amountPaid;
                    if (remaining < 0) remaining = 0;
                    trnRemainingAmount.value = remaining.toFixed(2);
                    if (trnTypeSelect.value === 'Receita') {
                        if (remaining === 0) {
                            document.getElementById('trn-status').value = 'Recebido';
                        } else if (remaining > 0) {
                            document.getElementById('trn-status').value = 'A Receber';
                        }
                    } else if (trnTypeSelect.value === 'Despesa') {
                        if (remaining === 0) {
                            document.getElementById('trn-status').value = 'Pago';
                        } else if (remaining > 0) {
                            document.getElementById('trn-status').value = 'A Pagar';
                        }
                    }
                };
                const toggleDynamicFields = () => {
                    const type = trnTypeSelect.value;
                    const category = trnCategorySelect.value;
                    const selectedProduct = trnProductSku.options[trnProductSku.selectedIndex];
                    const productStock = selectedProduct && selectedProduct.dataset.qty ? parseInt(selectedProduct.dataset.qty) : 0;
                    const productPrice = selectedProduct && selectedProduct.dataset.price ? parseFloat(selectedProduct.dataset.price) : 0;
                    const productCost = selectedProduct && selectedProduct.dataset.cost ? parseFloat(selectedProduct.dataset.cost) : 0;
                    const isProductRelated = (type === 'Receita' && category === 'Vendas') ||
                        (type === 'Despesa' && category === 'Produto (Compra de Estoque)');
                    productSelectionGroup.style.display = isProductRelated ? 'block' : 'none';
                    if (!isProductRelated) {
                        trnProductSku.value = '';
                        trnQty.value = 1;
                        currentStockInfo.textContent = '';
                        trnBaseValue.readOnly = false;
                    } else {
                        currentStockInfo.textContent = `Estoque atual: ${productStock}`;
                        if (type === 'Receita' && category === 'Vendas' && trnProductSku.value) {
                             trnBaseValue.value = (productPrice * (parseInt(trnQty.value) || 1)).toFixed(2);
                             trnBaseValue.readOnly = true;
                        } else if (type === 'Despesa' && category === 'Produto (Compra de Estoque)' && trnProductSku.value) {
                             trnBaseValue.value = (productCost * (parseInt(trnQty.value) || 1)).toFixed(2);
                             trnBaseValue.readOnly = false;
                        } else {
                            trnBaseValue.readOnly = false;
                        }
                    }
                    clientIdGroup.style.display = (type === 'Receita' && category === 'Vendas') ? 'block' : 'none';
                    if (!(type === 'Receita' && category === 'Vendas')) trnClientId.value = '';
                    salesPaymentSection.style.display = (type === 'Receita' && category === 'Vendas') ? 'block' : 'none';
                    if (!(type === 'Receita' && category === 'Vendas')) {
                        trnDiscountType.value = 'none';
                        trnDiscountValue.value = 0;
                        trnTotalAfterDiscount.value = 0;
                        trnAmountPaid.value = 0;
                        trnRemainingAmount.value = 0;
                    }
                    calculateRemainingAmount();
                };
                trnTypeSelect.addEventListener('change', updateCategoryOptions);
                trnCategorySelect.addEventListener('change', toggleDynamicFields);
                trnProductSku.addEventListener('change', toggleDynamicFields);
                trnQty.addEventListener('input', toggleDynamicFields);
                trnBaseValue.addEventListener('input', calculateRemainingAmount);
                trnDiscountType.addEventListener('change', calculateRemainingAmount);
                trnDiscountValue.addEventListener('input', calculateRemainingAmount);
                trnAmountPaid.addEventListener('input', calculateRemainingAmount);
                
                updateCategoryOptions();
                toggleDynamicFields();
                if (transaction) {
                    trnProductSku.value = transaction.productSku ||'';
                    trnQty.value = transaction.qty || 1;
                    trnClientId.value = transaction.clientId || '';
                    trnDiscountType.value = transaction.discountType || 'none';
                    trnDiscountValue.value = transaction.discountValue || 0;
                    trnAmountPaid.value = transaction.value;
                    trnBaseValue.value = transaction.originalValue || transaction.value;
                    toggleDynamicFields();
                }
                dom.transactionForm.onsubmit = (e) => {
                    e.preventDefault();
                    const type = trnTypeSelect.value;
                    const category = trnCategorySelect.value;
                    const productSku = trnProductSku.value;
                    let qty = parseInt(trnQty.value || 0);
                    const baseValue = parseFloat(trnBaseValue.value);
                    const clientId = trnClientId.value;
                    let status = document.getElementById('trn-status').value;
                    let originalSaleValue = baseValue;
                    let discountType = trnDiscountType.value;
                    let discountValue = parseFloat(trnDiscountValue.value) || 0;
                    let amountPaid = parseFloat(trnAmountPaid.value);
                    let remainingAmount = parseFloat(trnRemainingAmount.value);
                    if (productSku) {
                        const product = state.products.find(p => p.sku === productSku);
                        if (product) {
                            const oldQty = transaction && transaction.productSku === productSku ? transaction.qty : 0;
                            if (type === 'Receita' && category === 'Vendas') {
                                if (product.qty + oldQty < qty) {
                                    alert(`Não há estoque suficiente para vender ${qty} unidades de ${product.name}. Disponível: ${product.qty + oldQty}`);
                                    return;
                                }
                            }
                        }
                    }
                    
                     const newTransactionData = {
                        date: document.getElementById('trn-date').value,
                        description: document.getElementById('trn-description').value.trim(),
                        type: type,
                         category: category,
                        value: type === 'Receita' ? amountPaid : baseValue,
                        productSku: productSku || null,
                        qty: qty,
                        status: status,
                        clientId: clientId || null,
                        originalValue: (type === 'Receita' && category === 'Vendas') ? originalSaleValue : null,
                        discountType: (type === 'Receita' && category === 'Vendas') ? discountType : null,
                        discountValue: (type === 'Receita' && category === 'Vendas') ? discountValue : null,
                        amountPaidForSale: (type === 'Receita' && category === 'Vendas') ? amountPaid : null,
                    };
                    if (transaction) {
                        const oldTransaction = { ...transaction };
                        Object.assign(transaction, newTransactionData);
                        
                        if (oldTransaction.productSku) {
                            const oldProduct = state.products.find(p => p.sku === oldTransaction.productSku);
                            if(oldProduct) {
                                if(oldTransaction.type === 'Receita' && oldTransaction.category === 'Vendas') oldProduct.qty += oldTransaction.qty;
                                else if(oldTransaction.type === 'Despesa' && oldTransaction.category === 'Produto (Compra de Estoque)') oldProduct.qty -= oldTransaction.qty;
                            }
                        }
                    } else {
                        newTransactionData.id = generateId('TRN');
                        state.transactions.push(newTransactionData);
                    }
                    
                    if (productSku) {
                        const product = state.products.find(p => p.sku === productSku);
                        if(product) {
                            if(type === 'Receita' && category === 'Vendas') product.qty -= qty;
                            else if(type === 'Despesa' && category === 'Produto (Compra de Estoque)') product.qty += qty;
                        }
                    }
                    if (newTransactionData.type === 'Receita' && newTransactionData.category === 'Vendas' && newTransactionData.clientId) {
                        const client = state.clients.find(c => c.id === newTransactionData.clientId);
                        const product = newTransactionData.productSku ? state.products.find(p => p.sku === newTransactionData.productSku) : null;
                        const transactionId = transaction ? transaction.id : newTransactionData.id;
                        let currentReceivable = state.receivables.find(r => r.transactionId === transactionId);
                        if (remainingAmount > 0) {
                            const receivableData = {
                                clientId: newTransactionData.clientId,
                                clientName: client ? client.name : 'N/A',
                                description: newTransactionData.description || (product ? product.name : 'Venda'),
                                originalAmount: originalSaleValue,
                                amountPaid: amountPaid,
                                discountAmount: (discountType === 'amount' ? discountValue : (originalSaleValue * discountValue / 100)),
                                purchaseDate: newTransactionData.date,
                                status: 'Pendente'
                            };
                            if (!currentReceivable) {
                                receivableData.id = generateId('REC');
                                receivableData.transactionId = transactionId;
                                receivableData.alerted = false;
                                state.receivables.push(receivableData);
                            } else {
                                Object.assign(currentReceivable, receivableData);
                            }
                        } else {
                            if (currentReceivable) {
                                state.receivables = state.receivables.filter(r => r.id !== currentReceivable.id);
                            }
                        }
                    } else if (transaction && transaction.type === 'Receita' && transaction.category === 'Vendas') {
                         state.receivables = state.receivables.filter(r => r.transactionId !== transaction.id);
                    }
                    saveData();
                    renderAll();
                    dom.transactionFormCard.classList.add('hidden');
                    editingId = null;
                };
            },
            showAmortizationForm: (receivableId) => {
                const receivable = state.receivables.find(r => r.id === receivableId);
                if (!receivable) return;
                const valueDue = receivable.originalAmount - receivable.amountPaid - receivable.discountAmount;
                showModal(`Amortizar Dívida: ${receivable.clientName}`, `
                    <p class="mb-4">Valor devido atual: <strong>${formatCurrency(valueDue)}</strong></p>
                    <form id="amortization-form" class="space-y-4">
                        <div class="form-group"><label for="amort-amount">Valor a Pagar:</label><input type="number" id="amort-amount" step="0.01" min="0.01" max="${valueDue.toFixed(2)}" required></div>
                        <div class="form-group"><label for="amort-date">Data do Pagamento:</label><input type="date" id="amort-date" value="${new Date().toISOString().split('T')[0]}" required></div>
                        <button type="submit" class="btn-primary w-full">Registrar Pagamento</button>
                    </form>
                `);
                document.getElementById('amortization-form').addEventListener('submit', e => {
                    e.preventDefault();
                    const amountPaid = parseFloat(document.getElementById('amort-amount').value);
                    const paymentDate = document.getElementById('amort-date').value;
                    if (amountPaid > valueDue) {
                        alert('Valor a pagar excede o valor devido.');
                        return;
                    }
                    receivable.amountPaid += amountPaid;
                    if (receivable.amountPaid + receivable.discountAmount >= receivable.originalAmount) {
                        receivable.status = 'Pago';
                    } else {
                         receivable.status = 'Parcialmente Pago';
                    }
                    state.transactions.push({
                        id: generateId('TRN'),
                        date: paymentDate,
                        description: `Pagamento parcial de ${receivable.description} (${receivable.clientName})`,
                        category: 'Pagamento de Dívida',
                        type: 'Receita',
                        value: amountPaid,
                        productSku: null,
                        qty: 0,
                        status: 'Recebido',
                        clientId: receivable.clientId
                    });
                    saveData();
                    renderAll();
                    hideModal();
                });
            },
            showDiscountForm: (receivableId) => {
                const receivable = state.receivables.find(r => r.id === receivableId);
                if (!receivable) return;
                const valueDue = receivable.originalAmount - receivable.amountPaid - receivable.discountAmount;
                showModal(`Aplicar Desconto: ${receivable.clientName}`, `
                    <p class="mb-4">Valor devido atual: <strong>${formatCurrency(valueDue)}</strong></p>
                    <form id="discount-form" class="space-y-4">
                        <div class="form-group">
                            <label for="discount-type">Tipo de Desconto:</label>
                            <select id="discount-type" class="form-group select">
                                <option value="percent">%</option>
                                <option value="amount">R$</option>
                            </select>
                         </div>
                        <div class="form-group"><label for="discount-value">Valor do Desconto:</label><input type="number" id="discount-value" step="0.01" min="0" required></div>
                        <button type="submit" class="btn-primary w-full">Aplicar Desconto</button>
                     </form>
                `);
                document.getElementById('discount-form').addEventListener('submit', e => {
                    e.preventDefault();
                    const discountType = document.getElementById('discount-type').value;
                    const discountValueInput = parseFloat(document.getElementById('discount-value').value);
                    let actualDiscountAmount = 0;
                    if (discountType === 'percent') {
                        actualDiscountAmount = (valueDue * discountValueInput) / 100;
                    } else { 
                        actualDiscountAmount = discountValueInput;
                    }
                    if (actualDiscountAmount > valueDue) {
                        alert('Valor do desconto excede o valor devido.');
                        return;
                    }
                    receivable.discountAmount += actualDiscountAmount;
                    if (receivable.amountPaid + receivable.discountAmount >= receivable.originalAmount) {
                        receivable.status = 'Pago';
                    } else {
                        receivable.status = 'Parcialmente Pago';
                    }
                    saveData();
                    renderAll();
                    hideModal();
                });
            },
            showEntityForm: (entityType, entity = null) => {
                dom.entityFormCard.classList.remove('hidden');
                dom.entityFormTitle.textContent = entity ? `Editar ${entityType === 'client' ? 'Cliente' : 'Fornecedor'}` : `Adicionar Novo ${entityType === 'client' ? 'Cliente' : 'Fornecedor'}`;
                let formHtml = '';
                if (entityType === 'client') {
                    formHtml = `
                        <div class="form-group"><label for="entity-name">Nome:</label><input type="text" id="entity-name" value="${entity ? entity.name : ''}" required></div>
                        <div class="form-group"><label for="entity-email">Email:</label><input type="email" id="entity-email" value="${entity ? entity.email : ''}"></div>
                        <div class="form-group"><label for="entity-phone">Telefone:</label><input type="text" id="entity-phone" value="${entity ? entity.phone : ''}"></div>
                    `;
                } else { // supplier
                    formHtml = `
                        <div class="form-group"><label for="entity-name">Nome da Empresa:</label><input type="text" id="entity-name" value="${entity ? entity.name : ''}" required></div>
                        <div class="form-group"><label for="entity-contact">Contato Principal:</label><input type="text" id="entity-contact" value="${entity ? entity.contact : ''}"></div>
                        <div class="form-group"><label for="entity-phone">Telefone:</label><input type="text" id="entity-phone" value="${entity ? entity.phone : ''}"></div>
                    `;
                }
                formHtml += `<button type="submit" class="btn-primary w-full">${entity ? 'Salvar Alterações' : 'Adicionar'}</button>`;
                dom.entityForm.innerHTML = formHtml;
                dom.entityForm.onsubmit = (e) => {
                    e.preventDefault();
                    const newEntity = {
                        name: document.getElementById('entity-name').value.trim(),
                        phone: document.getElementById('entity-phone').value.trim(),
                    };
                    if (entityType === 'client') {
                        newEntity.email = document.getElementById('entity-email').value.trim();
                    } else {
                        newEntity.contact = document.getElementById('entity-contact').value.trim();
                    }
                    if (entity) {
                        Object.assign(entity, newEntity);
                    } else {
                        newEntity.id = generateId(entityType === 'client' ? 'CLI' : 'FOR');
                        if (entityType === 'client') {
                            state.clients.push(newEntity);
                        } else {
                            state.suppliers.push(newEntity);
                        }
                    }
                    saveData();
                    renderAll();
                    dom.entityFormCard.classList.add('hidden');
                    editingId = null;
                };
            }
    };
    window.app = app;

    // --- INICIALIZAÇÃO DA APLICAÇÃO ---
    function initApp() {
        const savedTheme = localStorage.getItem('gestao5.0_theme') || 'light';
        applyTheme(savedTheme);
        renderAll();
        switchTab('overview');
        setInterval(updateNotifications, 60000);

        // --- EVENT LISTENERS (REWRITTEN FOR STABILITY) ---
        dom.nav.overview.addEventListener('click', () => switchTab('overview'));
        dom.nav.stock.addEventListener('click', () => switchTab('stock'));
        dom.nav.cashflow.addEventListener('click', () => switchTab('cashflow'));
        dom.nav.finance.addEventListener('click', () => switchTab('finance'));
        dom.nav.receivables.addEventListener('click', () => switchTab('receivables'));
        dom.nav.entities.addEventListener('click', () => switchTab('entities'));
        dom.modalCloseBtn.addEventListener('click', hideModal);
        dom.themeToggle.addEventListener('click', toggleTheme);
        dom.dashboardPeriod.addEventListener('change', () => {
            if (dom.dashboardPeriod.value === 'custom') {
                dom.customDateRange.classList.remove('hidden');
            } else {
                dom.customDateRange.classList.add('hidden');
                currentFilterStartDate = null;
                currentFilterEndDate = null;
                renderDashboard();
            }
        });
        dom.applyCustomRange.addEventListener('click', () => {
            currentFilterStartDate = new Date(dom.startDate.value);
            currentFilterEndDate = new Date(dom.endDate.value);
            renderDashboard();
        });
        dom.financePeriod.addEventListener('change', () => {
            if (dom.financePeriod.value === 'custom') {
                dom.customFinanceDateRange.classList.remove('hidden');
            } else {
                dom.customFinanceDateRange.classList.add('hidden');
                currentFinanceFilterStartDate = null;
                currentFinanceFilterEndDate = null;
                renderFinancialTables();
                renderFinanceChart();
            }
        });
        dom.applyFinanceCustomRange.addEventListener('click', () => {
            currentFinanceFilterStartDate = new Date(dom.financeStartDate.value);
            currentFinanceFilterEndDate = new Date(dom.financeEndDate.value);
            renderFinancialTables();
            renderFinanceChart();
        });
        dom.nav.reports.addEventListener('click', () => dom.nav.reportsDropdown.classList.toggle('hidden'));
        dom.reportLinks.abc.addEventListener('click', (e) => { e.preventDefault(); renderABCReport(); dom.nav.reportsDropdown.classList.add('hidden'); });
        dom.reportLinks.dre.addEventListener('click', (e) => { e.preventDefault(); renderDRE(); dom.nav.reportsDropdown.classList.add('hidden'); });
        dom.notifications.bell.addEventListener('click', () => {
            const wasHidden = dom.notifications.panel.classList.contains('hidden');
            dom.notifications.panel.classList.toggle('hidden');
            
            if (!wasHidden) {
                dom.notifications.count.classList.add('hidden');
                dom.notifications.panel.innerHTML = '<div class="notification-item">Nenhuma notificação nova.</div>';
                state.receivables.forEach(r => r.alerted = false);
                saveData();
            }
        });
        dom.stockAdjustBtn.addEventListener('click', app.handleStockAdjustment);
        dom.csvUpload.addEventListener('change', app.handleCsvImport);
        dom.addProductBtn.addEventListener('click', () => { editingId = null; app.showProductForm(); });
        dom.addTransactionBtn.addEventListener('click', () => { editingId = null; app.showTransactionForm(); });
        dom.addClientBtn.addEventListener('click', () => { editingId = null; app.showEntityForm('client'); });
        dom.addSupplierBtn.addEventListener('click', () => { editingId = null; app.showEntityForm('supplier'); });
        document.getElementById('product-search').addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            document.querySelectorAll('#products-table tbody tr').forEach(row => {
                row.style.display = row.textContent.toLowerCase().includes(searchTerm) ? '' : 'none';
            });
        });
        document.getElementById('transaction-search').addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            document.querySelectorAll('#transactions-table tbody tr').forEach(row => {
                row.style.display = row.textContent.toLowerCase().includes(searchTerm) ? '' : 'none';
            });
        });
        document.getElementById('download-excel-btn').addEventListener('click', () => {
            const wb = XLSX.utils.book_new();
            const productsHeaders = ['SKU', 'Produto', 'Categoria', 'Quantidade', 'Cor', 'Custo', 'Preço Venda', 'Estoque Mínimo'];
            const productsData = state.products.map(p => [p.sku, p.name, p.category, p.qty, p.color, p.cost, p.price, p.minStock]);
            const ws_products = XLSX.utils.aoa_to_sheet([productsHeaders, ...productsData]);
            XLSX.utils.book_append_sheet(wb, ws_products, 'Produtos');
            const transactionsHeaders = ['ID', 'Data', 'Descrição', 'Tipo', 'Categoria', 'Valor', 'SKU Produto', 'Qtd. Produto', 'Status', 'Cliente ID', 'Valor Original Venda', 'Tipo Desconto', 'Valor Desconto', 'Valor Pago na Venda'];
            const transactionsData = state.transactions.map(t => [t.id, t.date, t.description, t.type, t.category, t.value, t.productSku, t.qty, t.status, t.clientId, t.originalValue, t.discountType, t.discountValue, t.amountPaidForSale]);
            const ws_transactions = XLSX.utils.aoa_to_sheet([transactionsHeaders, ...transactionsData]);
            XLSX.utils.book_append_sheet(wb, ws_transactions, 'Transacoes');
            const clientsHeaders = ['ID', 'Nome', 'Email', 'Telefone'];
            const clientsData = state.clients.map(c => [c.id, c.name, c.email, c.phone]);
            const ws_clients = XLSX.utils.aoa_to_sheet([clientsHeaders, ...clientsData]);
            XLSX.utils.book_append_sheet(wb, ws_clients, 'Clientes');
            const suppliersHeaders = ['ID', 'Nome', 'Contato', 'Telefone'];
            const suppliersData = state.suppliers.map(s => [s.id, s.name, s.contact, s.phone]);
            const ws_suppliers = XLSX.utils.aoa_to_sheet([suppliersHeaders, ...suppliersData]);
            XLSX.utils.book_append_sheet(wb, ws_suppliers, 'Fornecedores');
            const receivablesHeaders = ['ID', 'ID Transacao', 'ID Cliente', 'Nome Cliente', 'Descricao', 'Valor Original', 'Valor Pago', 'Desconto Aplicado', 'Data Compra', 'Data Vencimento', 'Status'];
            const receivablesData = state.receivables.map(r => [r.id, r.transactionId, r.clientId, r.clientName, r.description, r.originalAmount, r.amountPaid, r.discountAmount, r.purchaseDate, r.dueDate, r.status]);
            const ws_receivables = XLSX.utils.aoa_to_sheet([receivablesHeaders, ...receivablesData]);
            XLSX.utils.book_append_sheet(wb, ws_receivables, 'Contas a Receber');
            XLSX.writeFile(wb, 'gestao_definitiva_dados.xlsx');
        });
        
        // --- EVENT LISTENERS PARA LOGIN/LOGOUT ---
        dom.loginBtn.addEventListener('click', () => {
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            dom.loginError.textContent = '';
            
            auth.signInWithEmailAndPassword(email, password)
                .catch(error => {
                    console.error("Erro de login:", error);
                    if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password') {
                        if (confirm('Usuário não encontrado ou senha incorreta. Deseja criar uma nova conta com este e-mail e senha?')) {
                            auth.createUserWithEmailAndPassword(email, password)
                               .catch(err => dom.loginError.textContent = `Erro ao criar conta: ${err.message}`);
                        } else {
                             dom.loginError.textContent = 'E-mail ou senha inválidos.';
                        }
                    } else {
                        dom.loginError.textContent = `Erro: ${error.message}`;
                    }
                });
        });

        dom.logoutBtn.addEventListener('click', () => {
            auth.signOut();
        });
    }

    </script>
</body>
</html>